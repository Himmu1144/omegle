{% extends 'home.html' %}

{% block body %}

{% load static %}
<style type="text/css">
.chat-log {
	height: 500px;
	overflow-x: hidden;
	overflow-y: auto;
	padding: 10px;
	background-color: #fff;
	font-size: 0.9em;
	flex-direction: column-reverse;
}
.profile-image{
	width: 33px;
	height: 33px;
	margin-top: 0px;
	margin-bottom: auto;
}
.profile-image:hover{
	cursor: pointer;
}
.username-span{
	font-weight: 600;
	margin-top: 0px;
	margin-bottom: auto;
	margin-left: 5px;
	margin-right: 5px;
}
.username-span:hover{
	cursor: pointer;
}
.msg-p{
	font-weight: 450;
	margin-top: 5px;
	margin-bottom: auto;
	margin-left: 5px;
	margin-right: 5px;
	white-space: normal;
	-ms-word-break: break-all;
	word-break: break-all;
}
.message-container{
	margin-top: 10px;
	justify-content: start;
}
.timestamp-span{
	font-weight: 400;
	font-size: 0.8em;
	color: var(--secondary-text-color);
}
.timestamp-span:hover{
	cursor: pointer;
}
#id_chatroom_loading_spinner{
		position: absolute;
}
.connected-users{
	color: red;
}
.connected-users-icon{
	color: red;
}
.connected-users-icon:hover{
	cursor: default;
}
#bar{
    color: black;
}
#txt-container{
    display: none;
}
</style>

<div class="card mt-3 container">
	<div class="card-header">
		<div class="d-flex flex-row justify-content-between">
			<h3 class="">Omegle</h3>
			<div class="d-flex flex-row align-items-center">
				<span class="material-icons m-auto pr-1 connected-users-icon">person_outline</span>
			</div>
			
		</div>
	</div>
	<div class="card-body p-1">
		<div class="d-flex flex-column" id="id_chat_log_container">
            <div class="d-flex flex-row justify-content-center" id="id_chatroom_loading_spinner_container">
				<div class="text-primary"  id="id_chatroom_loading_spinner" role="status"  style="display: block; ">
					<span id='bar'>looking for someone you can chat with....</span>
				</div>
			</div>
			<div class="d-flex chat-log" id="id_chat_log">
			</div>
            <a href="{% url 'new-chat' %}"><button type="button" id='new_chat' class="btn btn-primary" style="display: none;">New Chat</button></a>  
            <div id="txt-container">
                <div class="d-flex chat-message-input-container" id='chat-message-input-container'>
                    <textarea class="flex-grow-1 chat-message-input" id="id_chat_message_input"></textarea>
                    <button class="btn btn-primary chat-message-submit-button">
                        <span id="id_chat_message_submit" class="material-icons">send
                        </span>
                    </button>
                </div>
            </div>
		</div>
	</div>
</div>

<script type="text/javascript">

    

    setupWebSocket()


    function setupWebSocket() {

        console.log("setupWebSocket: ")

        // Correctly decide between ws:// and wss://
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + '://' + window.location.host + "/chat/" ; // development
        


        // console.log("Connecting to " + ws_path);
        chatSocket = new WebSocket(ws_path);

        // Handle incoming messages
        chatSocket.onmessage = function (message) {
            // Decode the JSON
            // console.log("Got chat websocket message " + message.data);
            console.log("Got websocket message.");
            var data = JSON.parse(message.data);
            


            // Handle errors (ClientError)
            if (data.error) {
                console.error(data.error + ": " + data.message)
                return;
            }
            // Handle joining (Client perspective)
            if (data.join) {
                console.log("Joining room " + data.join);
                window.group_name = data.join
                window.user1_id = data.user1_id
                displayChatroomLoadingSpinner(data.spinner)
                var txt = document.getElementById('txt-container')
                txt.style.display = 'block'
            }

            // Handle getting a message
            if (data.msg_type == 0) {
                console.log(data);
                appendChatMessage(data, true)
            }

            if (data.msg_type == 1) {
                console.log(data);
                if(data.id == window.user1_id){
                    var message = 'You have diconnected.'
                }
                else{
                    var message = 'Stranger has disconnected.'
                }
                displayChatroomLoadingSpinner(message)
                var txt = document.getElementById('txt-container')
                txt.style.display = 'none'
                var new_chat = document.getElementById('new_chat')
                new_chat.style.display = 'block'

                
            }

            // Handle leaving (client perspective)
            if (data.leave) {
                // do nothing
                console.log("Leaving room " + data.leave);
            }
            if (data.general_message_type) {
                console.log("User" + data.user);
            }
            if(data.msg){
                console.log(data.msg);
            }
        };

        chatSocket.addEventListener("open", function (e) {
            console.log("ChatSocket OPEN")
            // join chat room
            if ("{{request.user.is_authenticated}}") {
                chatSocket.send(JSON.stringify({
                    "command": "join",
                }));
            }
        })

        chatSocket.onclose = function (e) {
            console.log('Chat socket closed.');
        };

        chatSocket.onOpen = function (e) {
            console.log("ChatSocket onOpen", e)
        }

        chatSocket.onerror = function (e) {
            console.log('ChatSocket error', e)
        }

        if (chatSocket.readyState == WebSocket.OPEN) {
            console.log("ChatSocket OPEN")
        } else if (chatSocket.readyState == WebSocket.CONNECTING) {
            console.log("ChatSocket connecting..")
        }
    }

    console.log(window.group_name , 'Can you see the group_name')
    document.getElementById('id_chat_message_input').focus();
	document.getElementById('id_chat_message_input').onkeyup = function(e) {
		if (e.keyCode === 13 && e.shiftKey) {  // enter + return
			// Handled automatically by textarea
		}
		else if(e.keyCode === 13 && !e.shiftKey){ // enter + !return
			document.getElementById('id_chat_message_submit').click();
		}
	};

    document.getElementById('id_chat_message_submit').onclick = function(e) {
		const messageInputDom = document.getElementById('id_chat_message_input');
		const message = messageInputDom.value;
		chatSocket.send(JSON.stringify({
			"command": "send",
			"message": message,
			"group_name": window.group_name,
            'user1_id' : window.user1_id
		}));
		messageInputDom.value = '';
	};

    function appendChatMessage(data, isNewMessage){
		message = data['message']
		uName = data['username']
		var msg = message + '\n';
		var username = uName + ": "
		createChatMessageElement(msg, username,  isNewMessage)
	}

    function createChatMessageElement(msg, username, isNewMessage){
		var chatLog = document.getElementById("id_chat_log")

		var newMessageDiv = document.createElement("div")
		newMessageDiv.classList.add("d-flex")
		newMessageDiv.classList.add("flex-row")
		newMessageDiv.classList.add("message-container")


		var div1 = document.createElement("div")
		div1.classList.add("d-flex")
		div1.classList.add("flex-column")

		var div2 = document.createElement("div")
		div2.classList.add("d-flex")
		div2.classList.add("flex-row")

		var usernameSpan = document.createElement("span")
		usernameSpan.addEventListener("click", function(e){
			//selectUser(user_id)
		})
		usernameSpan.classList.add("username-span")
		usernameSpan.innerHTML = username
		div2.appendChild(usernameSpan)


		div1.appendChild(div2)

		var msgP = document.createElement("p")
		msgP.innerHTML = msg
		msgP.classList.add("msg-p")
		div1.appendChild(msgP)

		newMessageDiv.appendChild(div1)

		if(isNewMessage){
			chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
		}
		
	}

    function displayChatroomLoadingSpinner(message){
		var spinner = document.getElementById("bar")
        spinner.innerHTML = message
	}

</script>

{% endblock body %}